<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vault Disaster Recovery Tool</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@noble/ed25519@2/index.min.js"></script>
    <script>
        // Ensure the noble-ed25519 library is correctly exposed
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof window.nobleEd25519 === 'undefined') {
                // If not exposed as expected, try to get it from the noble_ed25519 or globalThis.ed25519 namespaces
                window.nobleEd25519 = window.noble_ed25519 || window.ed25519 || globalThis.ed25519;
                console.log("Noble ed25519 library initialized:", window.nobleEd25519 ? "success" : "failed");
            }
        });
    </script>
    <script src="/static/main.js" defer></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>TSS Vault Disaster Recovery Tool</h1>
            <div class="sub-header">Securely recover private keys from your vault backup files</div>
        </header>

        <div class="notice">
            <strong>Important Security Notice:</strong>
            <p>This app does not communicate with any external hosts or services.
            It runs entirely in your local browser and does not require an internet connection.</p>
            <p>For maximum security, we recommend using this tool on an air-gapped device in incognito mode.</p>
        </div>

        <div id="step-1" class="step active">
            <h2>Step 1: Upload Vault Files</h2>
            <p>Please upload your vault backup files and enter the corresponding mnemonics.</p>

            <div id="files-error" class="error-message" style="display: none;">
                <div class="error-icon">⚠</div>
                <div class="error-content">
                    <h4>Error</h4>
                    <p id="files-error-message"></p>
                </div>
            </div>

            <div id="files-container">
                <div class="file-input-group">
                    <div class="file-upload">
                        <label for="file-1">Select File</label>
                        <input type="file" id="file-1" class="file-input" accept=".json,.bin">
                        <span class="file-name">No file selected</span>
                    </div>
                    <div class="mnemonic-input">
                        <label for="mnemonic-1">24-word Mnemonic Phrase</label>
                        <textarea id="mnemonic-1" class="mnemonic" rows="3" placeholder="Enter your 24-word mnemonic phrase for this file..."></textarea>
                    </div>
                    <button class="remove-file" data-index="1">✕</button>
                </div>
            </div>

            <div class="actions">
                <button id="add-file" class="secondary">+ Add Another File</button>
                <button id="next-to-vaults" class="primary">Next: Select Vault</button>
            </div>
        </div>

        <div id="step-2" class="step">
            <h2>Step 2: Select Vault</h2>
            <div id="vaults-loading" class="loading">
                <div class="spinner"></div>
                <p>Processing vault files...</p>
            </div>

            <div id="vaults-container">
                <table id="vaults-table">
                    <thead>
                        <tr>
                            <th>Vault Name</th>
                            <th>Vault ID</th>
                            <th>Threshold</th>
                            <th>Shares</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="vaults-list">
                        <!-- Vault entries will be added here dynamically -->
                    </tbody>
                </table>
            </div>

            <div id="advanced-options">
                <h3>Advanced Options</h3>
                <div class="option-group">
                    <label for="nonce-override">Reshare Nonce Override:</label>
                    <input type="number" id="nonce-override" placeholder="(Optional)" min="-1">
                    <span class="hint">Only provide if advised to do so</span>
                </div>
                <div class="option-group">
                    <label for="quorum-override">Threshold Override:</label>
                    <input type="number" id="quorum-override" placeholder="(Optional)" min="0">
                    <span class="hint">Only provide if advised to do so</span>
                </div>
                <div class="option-group">
                    <label for="export-password">Export Password:</label>
                    <input type="password" id="export-password" placeholder="(Optional for wallet export)">
                    <span class="hint">Required to export Ethereum wallet file</span>
                </div>
                <div class="option-group">
                    <label for="export-file">Export Filename:</label>
                    <input type="text" id="export-file" placeholder="(Optional)">
                    <span class="hint">Ethereum wallet file name</span>
                </div>
            </div>

            <div class="actions">
                <button id="back-to-files" class="secondary">Back</button>
                <button id="recover-vault" class="primary">Recover Selected Vault</button>
            </div>
        </div>

        <div id="step-3" class="step">
            <h2>Step 3: Recovery Results</h2>

            <div id="recovery-loading" class="loading">
                <div class="spinner"></div>
                <p>Recovering your vault keys...</p>
                <p class="hint">This may take a few moments</p>
            </div>

            <div id="recovery-error" class="error-box">
                <h3>Recovery Failed</h3>
                <p id="error-message">Error message will appear here</p>
                <button id="back-from-error" class="secondary">Back to Vault Selection</button>
            </div>

            <div id="recovery-results">
                <div class="vault-info">
                    <h3>Recovered Vault: <span id="vault-name"></span></h3>
                    <p>Vault ID: <span id="vault-id"></span></p>
                </div>
                
                <div class="result-section">
                    <h3>Ethereum Address</h3>
                    <p>Make sure this matches your vault's Ethereum address:</p>
                    <div class="key-display" id="eth-address"></div>
                </div>

                <div class="result-section">
                    <h3>ECDSA Private Key</h3>
                    <p>For Ethereum, Tron, and other ECDSA-based assets:</p>
                    <div class="key-display sensitive" id="ecdsa-private-key"></div>
                    <button class="copy-btn" data-target="ecdsa-private-key">Copy</button>
                </div>

                <div class="result-section">
                    <h3>Bitcoin WIF Keys</h3>
                    <p>For Bitcoin wallet recovery:</p>
                    <div class="sub-section">
                        <label>Testnet WIF (for tb1 addresses):</label>
                        <div class="key-display sensitive" id="testnet-wif"></div>
                        <button class="copy-btn" data-target="testnet-wif">Copy</button>
                    </div>
                    <div class="sub-section">
                        <label>Mainnet WIF (for bc1 addresses):</label>
                        <div class="key-display sensitive" id="mainnet-wif"></div>
                        <button class="copy-btn" data-target="mainnet-wif">Copy</button>
                    </div>
                </div>

                <div id="eddsa-section" class="result-section">
                    <h3>EdDSA Private Key</h3>
                    <p>For EdDSA-based assets like Solana, XRPL, and Bittensor:</p>
                    <div class="key-display sensitive" id="eddsa-private-key"></div>
                    <button class="copy-btn" data-target="eddsa-private-key">Copy</button>

                    <div id="additional-addresses">
                        <div class="sub-section">
                            <label>EdDSA Public Key:</label>
                            <div class="key-display" id="eddsa-public-key"></div>
                            <button class="copy-btn" data-target="eddsa-public-key">Copy</button>
                        </div>

                        <div class="sub-section">
                            <label>XRPL Address:</label>
                            <div class="key-display" id="xrpl-address"></div>
                            <div class="action-buttons">
                                <button class="copy-btn" data-target="xrpl-address">Copy</button>
                                <button class="transaction-btn" data-blockchain="xrpl">Create Transaction</button>
                            </div>
                        </div>

                        <div class="sub-section">
                            <label>Bittensor Address (SS58):</label>
                            <div class="key-display" id="bittensor-address"></div>
                            <div class="action-buttons">
                                <button class="copy-btn" data-target="bittensor-address">Copy</button>
                                <button class="transaction-btn" data-blockchain="bittensor">Create Transaction</button>
                            </div>
                        </div>

                        <div class="sub-section">
                            <label>Solana Address:</label>
                            <div class="key-display" id="solana-address"></div>
                            <div class="action-buttons">
                                <button class="copy-btn" data-target="solana-address">Copy</button>
                                <button class="transaction-btn" data-blockchain="solana">Create Transaction</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="wallet-instructions">
                    <h3>Wallet Import Instructions</h3>
                    <ul>
                        <li><strong>Ethereum & MetaMask:</strong> Import using the hex ECDSA private key or the exported wallet.json file</li>
                        <li><strong>Bitcoin & Electrum:</strong> Import using WIF with p2wpkh: prefix</li>
                        <li><strong>XRPL:</strong> Click the "Create Transaction" button next to the XRPL address to send XRP tokens</li>
                        <li><strong>Bittensor:</strong> Click the "Create Transaction" button next to the Bittensor address to send TAO tokens</li>
                        <li><strong>Solana:</strong> Click the "Create Transaction" button next to the Solana address to send SOL tokens</li>
                        <li><strong>Others:</strong> Some wallets may require you to prefix hex strings with 0x</li>
                    </ul>
                </div>

                <div class="security-notice">
                    <p><strong>Important:</strong> Keep these keys safe and do not share them with anyone.</p>
                    <p>For maximum security, disconnect your device from the internet after recovery.</p>
                </div>

                <div class="actions">
                    <button id="start-over" class="secondary">Start Over</button>
                </div>
            </div>
        </div>

        <!-- Transaction Dialogs -->
        <div id="xrpl-transaction-dialog" class="transaction-dialog">
            <div class="transaction-dialog-content">
                <span class="close-dialog">&times;</span>
                <h3>XRPL Transaction</h3>

                <div class="transaction-form">
                    <div class="network-selection">
                        <label>Network:</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="xrpl-network" value="testnet" checked>
                                Testnet
                            </label>
                            <label>
                                <input type="radio" name="xrpl-network" value="mainnet">
                                Mainnet
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="xrpl-destination">Destination Address:</label>
                        <input type="text" id="xrpl-destination" placeholder="Enter XRP destination address">
                    </div>

                    <div class="form-group">
                        <label for="xrpl-amount">Amount (XRP):</label>
                        <input type="number" id="xrpl-amount" placeholder="Enter amount to send">
                    </div>

                    <div class="transaction-status" id="xrpl-status"></div>

                    <div class="transaction-actions">
                        <button id="xrpl-check-balance" class="secondary">Check Balance</button>
                        <button id="xrpl-prepare-tx" class="primary">Prepare Transaction</button>
                    </div>

                    <div id="xrpl-prepared-tx" class="prepared-transaction">
                        <h4>Prepared Transaction</h4>
                        <div class="form-group">
                            <label>Transaction Details:</label>
                            <div class="tx-details" id="xrpl-tx-details"></div>
                        </div>
                        <div class="transaction-actions">
                            <button id="xrpl-sign-tx" class="secondary">Sign Transaction</button>
                            <button id="xrpl-broadcast-tx" class="primary">Broadcast Transaction</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="bittensor-transaction-dialog" class="transaction-dialog">
            <div class="transaction-dialog-content">
                <span class="close-dialog">&times;</span>
                <h3>Bittensor Transaction</h3>

                <div class="transaction-form">
                    <div class="form-group">
                        <label for="bittensor-endpoint">Network Endpoint:</label>
                        <input type="text" id="bittensor-endpoint" value="wss://entrypoint-finney.opentensor.ai:443" placeholder="Enter Bittensor network endpoint">
                    </div>

                    <div class="form-group">
                        <label for="bittensor-destination">Destination Address:</label>
                        <input type="text" id="bittensor-destination" placeholder="Enter Bittensor destination address">
                    </div>

                    <div class="form-group">
                        <label for="bittensor-amount">Amount (TAO):</label>
                        <input type="number" id="bittensor-amount" placeholder="Enter amount to send">
                    </div>

                    <div class="transaction-status" id="bittensor-status"></div>

                    <div class="transaction-actions">
                        <button id="bittensor-prepare-tx" class="primary">Prepare Transaction</button>
                    </div>

                    <div id="bittensor-prepared-tx" class="prepared-transaction">
                        <h4>Prepared Transaction</h4>
                        <div class="form-group">
                            <label>Transaction Details:</label>
                            <div class="tx-details" id="bittensor-tx-details"></div>
                        </div>
                        <div class="transaction-actions">
                            <button id="bittensor-broadcast-tx" class="primary">Broadcast Transaction</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="solana-transaction-dialog" class="transaction-dialog">
            <div class="transaction-dialog-content">
                <span class="close-dialog">&times;</span>
                <h3>Solana Transaction</h3>

                <div class="transaction-form">
                    <div class="network-selection">
                        <label>Network:</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="solana-network" value="mainnet">
                                Mainnet
                            </label>
                            <label>
                                <input type="radio" name="solana-network" value="testnet">
                                Testnet
                            </label>
                            <label>
                                <input type="radio" name="solana-network" value="devnet" checked>
                                Devnet
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="solana-destination">Destination Address:</label>
                        <input type="text" id="solana-destination" placeholder="Enter Solana destination address">
                    </div>

                    <div class="form-group">
                        <label for="solana-amount">Amount (SOL):</label>
                        <input type="number" id="solana-amount" placeholder="Enter amount to send">
                    </div>

                    <div class="transaction-status" id="solana-status"></div>

                    <div class="transaction-actions">
                        <button id="solana-check-balance" class="secondary">Check Balance</button>
                        <button id="solana-prepare-tx" class="primary">Prepare Transaction</button>
                    </div>

                    <div id="solana-prepared-tx" class="prepared-transaction">
                        <h4>Prepared Transaction</h4>
                        <div class="form-group">
                            <label>Transaction Details:</label>
                            <div class="tx-details" id="solana-tx-details"></div>
                        </div>
                        <div class="transaction-actions">
                            <button id="solana-sign-tx" class="secondary">Sign Transaction</button>
                            <button id="solana-broadcast-tx" class="primary">Broadcast Transaction</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
